#!/usr/bin/env python3
# -*- coding: utf-8 -*-

####################################################################################
# - COPYRIGHT - 
####################################################################################

"""
headerize-cli — A simple CLI utility for generating formatted text headers.

Copyright (c) 2025 Bogdan Pricope
SPDX-License-Identifier: BSD-3-Clause
"""

####################################################################################
# - MODULES - 
####################################################################################

import argparse
import sys

####################################################################################
# - FUNCTIONS - 
####################################################################################

def header(head: str, style: str, char: str, width: str | int, box: int, align: str, parser) -> str:
    """This function takes a string and formats it as a header, using the specified style, width and character."""

    ########################### - BOXED HEADER FORMAT - ############################

    formatted_head = f" {head} "

    width = get_width(width, box, style, formatted_head, parser)
    align = get_align(align, box, style, parser)

    if box != 'none':
        if box == 'thin': # style 2
            v  = "│" # vertical
            h  = "─" # horizontal
            ul = "┌" # upper left
            ur = "┐" # upper right
            bl = "└" # bottom left
            br = "┘" # bottom right
        elif box == 'thick': # style 3
            v  = "┃" # vertical
            h  = "━" # horizontal
            ul = "┏" # upper left
            ur = "┓" # upper right
            bl = "┗" # bottom left
            br = "┛" # bottom right
        elif box == 'round': # style 4
            v  = "│" # vertical
            h  = "─" # horizontal
            ul = "╭" # upper left
            ur = "╮" # upper right
            bl = "╰" # bottom left
            br = "╯" # bottom right
        elif box == 'double': # style 1
            v  = "║" # vertical
            h  = "═" # horizontal
            ul = "╔" # upper left
            ur = "╗" # upper right
            bl = "╚" # bottom left
            br = "╝" # bottom right
        else:
            parser.error(f"{box} is not a valid choice.")

        top     = ul + h * (width - 2) + ur
        bottom  = bl + h * (width - 2) + br

        return f"{top}\n{v}{formatted_head:{align}{width - 2}}{v}\n{bottom}"

    ############################ - CHAR HEADER FORMAT - ############################

    char_len = len(char)

    if char_len > 1:
        char = char[0]

    border = char * width

    if style == 'single':
        return f"{formatted_head:{char}{align}{width}}"
    elif style == 'multi':
        return f"{border}\n{char * char_len}{formatted_head:{align}{width-char_len}}\n{border}"
    elif style == 'boxed':
        return f"{border}\n{char * char_len}{formatted_head:{align}{width-2*char_len}}{char * char_len}\n{border}"

############################# - WIDTH CHECK FUNCTION - #############################

def get_width(width: str, box: str, style: str, header: str, parser) -> int:
    """Determine the width of the header based on input parameters."""

    header_width = len(header) + 2

    if width.lower() == 'default' and box.lower() == 'none':
        return 84
    elif width.lower() == 'auto' or style.lower() == 'boxed' or width.lower() == 'default' and box.lower() != 'none':
        return header_width
    else:
        try:
            width = int(width)
            if width <= 0:
                parser.error(f"Width must be positive, got {width}")
            return max(width, header_width)
        except ValueError:
            raise parser.error(f"Width must be integer or 'auto', got {width}")

def get_align(align: str, box: str, style: str, parser) -> str:
    if align.lower() == "left":
        return "<"
    elif align.lower() == "right":
        return ">"
    elif align.lower() == "center":
        return "^"
    elif align.lower() == 'default' and box.lower() != 'none' or style.lower() == 'single' or style.lower() == 'boxed':
        return "^"
    elif align.lower() == 'default' and style.lower() == 'multi':
        return "<"
    else:
        parser.error(f"Invalid option {align}")

####################################################################################
# - MAIN - 
####################################################################################

def main():

    ############################### - PARSER SETUP - ###############################

    parser = argparse.ArgumentParser(
        description="Format a title with a border.",
        formatter_class=argparse.ArgumentDefaultsHelpFormatter
    )

    ####################### - VALUE OPTIONS CONFIGURATION - ########################

    parser.add_argument("head", nargs="?", help="The header text")
    parser.add_argument("-H", "--head", dest="header", help="The header text (alternative flag form).")
    parser.add_argument("-s", "--style", choices=["single", "multi", "boxed"], default="single", help="Border style.")
    parser.add_argument("-c", "--char", default="#", help="Character to use for the border.")
    parser.add_argument("-w", "--width", default='default', help="Width of the rows.", type=str)
    parser.add_argument("-b", "--box", choices=["thin", "thick", "round", "double"], default='none', help="Used do display boxed text.", type=str)
    parser.add_argument("-a", "--align", choices=['left', 'right', 'center'], default='default', help="Used do display boxed text.", type=str)

    ####################### - BOOLEAN FLAGS CONFIGURATION - ########################

    case_group = parser.add_mutually_exclusive_group()
    case_group.add_argument("-U", "--upper", action="store_true", help="Converts header to UPPERCASE.")
    case_group.add_argument("-L" ,"--lower", action="store_true", help="Converts header to lowercase.")
    case_group.add_argument("-T", "--title", action="store_true", help="Converts header to Title_Case.")
    case_group.add_argument("-S", "--swapcase", action="store_true", help="Converts header to sWAPcASE.")

    ############################# - ARGUMENT PARSING - #############################

    args = parser.parse_args()

    ############################ - HEADER FORMATTING - #############################

    # Prefer --head flag over positional head
    head = args.header or args.head

    if not head:
        # If neither positional nor flag provided, read from stdin (pipe)
        if not sys.stdin.isatty():
            head = sys.stdin.read().strip()
        else:
            parser.error("You must provide a title, either positionally or with -H/--head.")

    if args.upper:
        head = head.upper()
    elif args.lower:
        head = head.lower()
    elif args.title:
        head = head.title()
    elif args.swapcase:
        head = head.swapcase()

    ############################## - FUNCTION CALL - ###############################

    print(header(head, args.style, args.char, args.width, args.box, args.align, parser))

####################################################################################
# - EXEC - 
####################################################################################

if __name__ == "__main__":
    main()

####################################################################################
# - END - 
####################################################################################
